#*******************************************************************************
# ALMA - Atacama Large Millimiter Array
# (c) European Southern Observatory, 2011 
# 
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
#
# "@(#) $Id: Makefile,v 1.48 2013/02/11 18:37:33 rbourtem Exp $"
#
# Makefile of ........
#
# who       when      what
# --------  --------  ----------------------------------------------
# bjeram  2011-04-19  created
#

#*******************************************************************************
# This Makefile follows ACS Standards (see Makefile(5) for more).
#*******************************************************************************
# REMARKS
#    None
#-------------------------------------------------------------------------------
-include rules.mk

#
#>>>>> END OF standard rules

#
# INCLUDE STANDARDS
# -----------------

MAKEDIRTMP := $(shell searchFile include/acsMakefile)
ifneq ($(MAKEDIRTMP),\#error\#)
   MAKEDIR := $(MAKEDIRTMP)/include
   include $(MAKEDIR)/acsMakefile
endif


#
# TARGETS
# -------

ifdef NDDSHOME

.DEFAULT_GOAL := all	
all: do_dds_gen	do_all
	@echo " . . . 'all' done" 

clean : clean_all dds_clean
	@echo " . . . clean done"

install : install_all
	$(AT)cp -f ../config/bulkDataNTDefaultQosProfiles.*.xml $(PRJTOP)/config
	$(AT)chmod $(P644) $(PRJTOP)/config/bulkDataNTDefaultQosProfiles.*.xml
	@echo " . . . installation done"
	
else

.DEFAULT_GOAL := all	
all: do_all
	@echo -e "\e[0;31mWARNING: NDDSHOME is not defined, and thus only code common to old and new BD will be build (ACSERR and IDL) for target all!!!!\e[0m" 

clean : clean_all
	@echo " . . . clean done"

install : install_all
	@echo -e "\e[0;31mWARNING: NDDSHOME is not defined, and thus only code common to old and new BD will be installed (ACSERR and IDL) for target install!!!!\e[0m"
	
endif
clean_dist : clean_all clean_dist_all 
	@echo " . . . clean_dist done"

man   : do_man 
	@echo " . . . man page(s) done"

	
	
do_dds_gen: $(CPP_DDS_GEN_FILES_PATH) $(JAVA_DDS_GEN_FILES_PATH)
	
.INTERMEDIATE: gencpp
$(CPP_DDS_GEN_FILES_PATH): gencpp
gencpp: $(DDS_IDL)
	$(NDDSHOME)/scripts/rtiddsgen -ppDisable -namespace -replace -d ./ $<; \
	rename .cxx .cpp *.cxx; \
	mv *.h ../include

.INTERMEDIATE: genjava
$(JAVA_DDS_GEN_FILES_PATH): genjava
genjava: $(DDS_IDL)
	$(NDDSHOME)/scripts/rtiddsgen -ppDisable -language Java -replace -package $(JAVA_PKG_NAME) -d ./ $<

dds_clean:
	rm -f $(CPP_DDS_GEN_FILES_PATH)
	rm -f $(JAVA_DDS_GEN_FILES_PATH)
	rm -rf $(JAVA_DDS_GEN_DIR)

# This "javadoc" target is overriden because the original target defined
# in acsMakefileCore.mk tries to generate javadoc of Java source files
# generated by "rtiddsgen" command, but it fails because the generated
# source files contain some Javadoc errors.
#
# The original target also redirects the standard error output to /dev/null,
# but it hides the error details when javadoc command fails for some reason.
# So, this newly defined target show the errors in the console.
javadoc:
	$(AT)echo "......Javadoc:"
	$(AT)mkdir -p $(JAVADOC_DIR)
	$(AT)javadoc $(JAVA_PKG_NAME) -protected -link http://docs.oracle.com/javase/8/docs/api/ -classpath `acsMakeJavaClasspath` -d $(JAVADOC_DIR) -sourcepath . > /dev/null
